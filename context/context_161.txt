QLoRa: Efficient Fine-
tuning of Quantized LLMs
Link: https://arxiv.org/abs/2305.14314
Nguyen-Thuan Duong
Dinh-Thang Duong
AI VIETNAM
Seminar
Tim Dettmers, Artidoro Pagnoni, Ari Holtzman, Luke 
Zettlemoyer
Outline
2
â–Abstract
â–Introduction
â–Background
â–Methods
â–Evaluation
â–Conclusion
â–Question
AI VIETNAM
Seminar
Abstract
3
â–Content
We present QLoRA, an efficient finetuning approach that reduces memory usage enough to finetune a 65B parameter model 
on a single 48GB GPU while preserving full 16-bit finetuning task performance. QLoRA backpropagates gradients through a 
frozen, 4-bit quantized pretrained language model into Low Rank Adapters~(LoRA). Our best model family, which we name 
Guanaco, outperforms all previous openly released models on the Vicuna benchmark, reaching 99.3% of the performance 
level of ChatGPT while only requiring 24 hours of finetuning on a single GPU. QLoRA introduces a number of innovations 
to save memory without sacrificing performance: (a) 4-bit NormalFloat (NF4), a new data type that is information 
theoretically optimal for normally distributed weights (b) double quantization to reduce the average memory footprint by 
quantizing the quantization constants, and (c) paged optimziers to manage memory spikes. We use QLoRA to finetune more 
than 1,000 models, providing a detailed analysis of instruction following and chatbot performance across 8 instruction 
datasets, multiple model types (LLaMA, T5), and model scales that would be infeasible to run with regular finetuning (e.g. 
33B and 65B parameter models). Our results show that QLoRA finetuning on a small high-quality dataset leads to state-of-
the-art results, even when using smaller models than the previous SoTA. We provide a detailed analysis of chatbot 
performance based on both human and GPT-4 evaluations showing that GPT-4 evaluations are a cheap and reasonable 
alternative to human evaluation. Furthermore, we find that current chatbot benchmarks are not trustworthy to accurately 
evaluate the performance levels of chatbots. A lemon-picked analysis demonstrates where Guanaco fails compared to 
ChatGPT. We release all of our models and code, including CUDA kernels for 4-bit training.
AI VIETNAM
Seminar
Introduction
4
â–Getting Started
â–Applications
â–Challenges
AI VIETNAM
Seminar
Introduction
5
â–What is LLMs?
AI VIETNAM
Seminar
LLMs (Large Language Models): Language models that were trained on a very large corpus of text. This made 
them capable of performing various NLP tasks with high precision.
Image Reference: https://wandb.ai/vincenttu/blog_posts/reports/A-Survey-of-Large-Language-Models--VmlldzozOTY2MDM1
Introduction
6
â–What is LLMs?
AI VIETNAM
Seminar
Image Reference: https://blogs.nvidia.com/blog/what-are-foundation-models/
LLMs are often pretrained on a 
vast majority of data and 
designed to be adaptable to a 
wide variety of tasks 
(Foundation models).
Introduction
7
â–What is LLMs?
AI VIETNAM
Seminar
Transformers Paper: https://arxiv.org/abs/1706.03762
Image Reference: https://heidloff.net/article/foundation-models-transformers-bert-and-gpt/
Introduction
8
â–What is LLMs?
AI VIETNAM
Seminar
Decoder
<start> 
I
Decoder
<start> I
am
Decoder
<start> I am
a
Decoder
<start> I am a
chatbot
Introduction
9
â–What is LLMs?
AI VIETNAM
Seminar
Image Reference: https://huggingface.co/blog/evaluating-mmlu-leaderboard
Introduction
10
â–What is LLMs?
AI VIETNAM
Seminar
Write a python function that receive an 
image and plot it using matplotlib 
library.
Prompt:
Introduction
11
â–LLMs size over time
AI VIETNAM
Seminar
Image Reference: https://www.marktechpost.com/wp-content/uploads/2023/10/Screenshot-2023-10-15-at-4.25.57-PM.png
Introduction
12
â–Low-precision
AI VIETNAM
Seminar
LLaMa-2 7B
LLaMa-2 13B
FP32 (32-bit)
28GB
FP16 (16-bit)
LLaMa-2 70B
Reference: https://docs.nvidia.com/ai-enterprise/workflows-generative-ai/0.1.0/sizing-guide.html
48GB
320GB
14GB
24GB
160GB
GPUs
GPUs
Load ONLY
Background
13
â–Quantization
â–LoRA
AI VIETNAM
Seminar
Background
14
â–Float Point (FP)
AI VIETNAM
Seminar
Float32
(float)
Sign
Exponent
Mantissa
Float16
(half)
8 bits
23 bits
5 bits
10 bits
Float64
(double)
11 bits
52 bits
Bfloat16
8 bits
7 bits
TensorFloat32
(TF32)
8 bits
10 bits
1 bit
Background
15
â–What is Quantization ?
AI VIETNAM
Seminar
Quantization refers to techniques for doing both computations 
and memory accesses with lower precision data, usually int8 
compared to floating point implementations.
Reference: https://pytorch.org/docs/stable/quantization.html#introduction-to-quantization
Reduce model 
size
Reduce memory 
bandwidth
Faster inference
-10
9
-128
127
Real range
Integer range
Mapping
Tensor Data
dtype = FP16
Compute
dtype=int8
Î±
Î²
Î±q
Î²q
-10
9
Real range
Tensor Data
dtype = FP16
Î±
Î²
Mapping
Quantize
Dequantize
Background
16
â–Int8 Quantization (Weight)
AI VIETNAM
Seminar
Reference: https://arxiv.org/pdf/2004.09602.pdf
0
ğ‘¥= 1
ğ‘¥ğ‘=?
-Î±
Î±=4
0
127
-127
Scale (Symmetric) Quantization
Quantize
Dequantize
Scale
ğ‘¥ğ‘= ğ‘ğ‘™ğ‘–ğ‘(ğ‘Ÿğ‘œğ‘¢ğ‘›ğ‘‘ğ‘ âˆ™ğ‘¥)
à·œğ‘¥= 1
ğ‘ ğ‘¥ğ‘
ğ‘ = 2ğ‘âˆ’1 âˆ’1
ğ›¼
ğ‘ = 28âˆ’1 âˆ’1
4
= 31.75
ğ‘¥ğ‘= ğ‘ğ‘™ğ‘–ğ‘(ğ‘Ÿğ‘œğ‘¢ğ‘›ğ‘‘31.75 Ã— 1 )
= 32
à·œğ‘¥=
1
31.75 32 = 1.007874 â€¦
Background
17
â–Int8 Quantization (Weight)
AI VIETNAM
Seminar
Reference: https://arxiv.org/pdf/2004.09602.pdf
0
Î² =-3
Î± =4
z
127
-128
Affine (Asymmetric) Quantization
ğ‘¥= 1
ğ‘¥ğ‘= ?
Scale
ğ‘ = 2ğ‘âˆ’1
ğ›¼âˆ’ğ›½
ğ‘§= âˆ’ğ‘Ÿğ‘œğ‘¢ğ‘›ğ‘‘ğ›½âˆ™ğ‘ âˆ’2ğ‘âˆ’1
Quantize
Dequantize
ğ‘¥ğ‘= ğ‘ğ‘™ğ‘–ğ‘(ğ‘Ÿğ‘œğ‘¢ğ‘›ğ‘‘ğ‘ âˆ™ğ‘¥+ ğ‘§)
à·œğ‘¥= 1
ğ‘ (ğ‘¥ğ‘âˆ’ğ‘§)
ğ‘ =
28 âˆ’1
4 âˆ’(âˆ’3) = 36.42
ğ‘¥ğ‘= ğ‘ğ‘™ğ‘–ğ‘(ğ‘Ÿğ‘œğ‘¢ğ‘›ğ‘‘36.42 Ã— 1 âˆ’19 ) = 17
à·œğ‘¥=
1
36.42 17 + 19) = 0.9882 â€¦
ğ‘§= âˆ’ğ‘Ÿğ‘œğ‘¢ğ‘›ğ‘‘âˆ’3 Ã— 36.42 âˆ’28âˆ’1
= âˆ’19
Background
18
â–Matrix Multiplication Quantization
AI VIETNAM
Seminar
Reference: https://leimao.github.io/article/Neural-Networks-Quantization/#Floating-Point-Quantization
ğ‘Œğ‘,ğ‘–,ğ‘—
= ğ‘§ğ‘Œ+ ğ‘ ğ‘Œ
ğ‘ ğ‘
ğ‘ğ‘,ğ‘—âˆ’ğ‘§ğ‘
+
ğ‘ ğ‘Œ
ğ‘ ğ‘‹ğ‘ ğ‘Š
à·
ğ‘˜=1
ğ‘
ğ‘‹ğ‘,ğ‘–,ğ‘˜ğ‘Šğ‘,ğ‘˜,ğ‘—
âˆ’
ğ‘§ğ‘Šà·
ğ‘˜=1
ğ‘
ğ‘‹ğ‘,ğ‘–,ğ‘˜
âˆ’
ğ‘§ğ‘‹à·
ğ‘˜=1
ğ‘
ğ‘Šğ‘,ğ‘˜,ğ‘—
+ ğ‘ğ‘§ğ‘‹ğ‘§ğ‘Š
ğ‘Œ= ğ‘‹ğ‘Š+ ğ‘
ğ‘Œğ‘–,ğ‘—= à·
ğ‘˜=1
ğ‘
ğ‘‹ğ‘–,ğ‘˜ğ‘Šğ‘˜,ğ‘—+ ğ‘ğ‘—
ğ‘ğ‘¢ğ‘ğ‘›ğ‘¡ğ‘–ğ‘§ğ‘’ğ‘¥, ğ‘ , ğ‘§= s âˆ™ğ‘¥+ ğ‘§
ğ‘‘ğ‘’ğ‘ğ‘¢ğ‘ğ‘›ğ‘¡ğ‘–ğ‘§ğ‘’ğ‘¥, ğ‘ , ğ‘§= 1
ğ‘¥ğ‘¥ğ‘âˆ’ğ‘§
Background
19
â–Activation Quantization
AI VIETNAM
Seminar
ğ‘¦ğ‘= àµ
ğ‘§ğ‘¦
ğ‘–ğ‘“ğ‘¥ğ‘< ğ‘§ğ‘¥
ğ‘§ğ‘¦+ ğ‘ ğ‘¦
ğ‘ ğ‘¥
ğ‘¥ğ‘âˆ’ğ‘§ğ‘¥
ğ‘–ğ‘“ğ‘¥ğ‘â‰¥ğ‘§ğ‘¥
Reference: https://leimao.github.io/article/Neural-Networks-Quantization/#Floating-Point-Quantization
ğ‘¦= ğ‘…ğ‘’ğ¿ğ‘ˆğ‘¥= á‰Š0
ğ‘–ğ‘“ğ‘¥< 0
ğ‘¥
ğ‘–ğ‘“ğ‘¥â‰¥0
ğ‘¦= ğ‘‘ğ‘’ğ‘ğ‘¢ğ‘ğ‘›ğ‘¡ğ‘–ğ‘§ğ‘’ğ‘¥ğ‘, ğ‘ ğ‘¥, ğ‘§ğ‘¥= 1
ğ‘ ğ‘¥
ğ‘¥ğ‘âˆ’ğ‘§ğ‘¥
ğ‘¦= ğ‘‘ğ‘’ğ‘ğ‘¢ğ‘ğ‘›ğ‘¡ğ‘–ğ‘§ğ‘’ğ‘¦ğ‘, ğ‘ ğ‘¦, ğ‘§ğ‘¦= 1
ğ‘ ğ‘¦
ğ‘¦ğ‘âˆ’ğ‘§ğ‘¦
â†’1
ğ‘ ğ‘¥
ğ‘¥ğ‘âˆ’ğ‘§ğ‘¥= 1
ğ‘ ğ‘¦
ğ‘¦ğ‘âˆ’ğ‘§ğ‘¦
â†’ğ‘¦ğ‘= ğ‘ ğ‘¦
ğ‘ ğ‘¥
ğ‘¥ğ‘âˆ’ğ‘§ğ‘¥
Background
20
â–Quantization types
AI VIETNAM
Seminar
Dynamic 
Quantization
Static/Post 
Quantization
Quantization aware 
training
Quantization
Reference: https://pytorch.org/docs/stable/quantization.html#introduction-to-quantization
CNN model
RNN, LSTM
Transformer
Background
21
â–Dynamic Quantization
AI VIETNAM
Seminar
Inference
Weights
Before Inference
Weights
ğ‘„ğ‘¢ğ‘ğ‘›ğ‘¡
Inputs
Weights
Activation
ğ‘„ğ‘¢ğ‘ğ‘›ğ‘¡
Output
Background
22
â–Static/Post Quantization
AI VIETNAM
Seminar
Weights
Before Inference
ğ‘„ğ‘¢ğ‘ğ‘›ğ‘¡
Weights
Samples
Activation
ğ‘„ğ‘¢ğ‘ğ‘›ğ‘¡
Inference
Inputs
Weights
Activation
Output
{S, Z}
{S, Z}
{S: scale, Z: zero point}
Background
23
â–Quantization aware training
AI VIETNAM
Seminar
Inference
Weights
Training
Weights
ğ¹ğ‘ğ‘˜ğ‘’_ğ‘„
Inputs
Activation
ğ¹ğ‘ğ‘˜ğ‘’_ğ‘„
Weights
Weights
ğ‘„ğ‘¢ğ‘ğ‘›ğ‘¡
Inputs
Activation
ğ‘„ğ‘¢ğ‘ğ‘›ğ‘¡
Output
Output
{ğ‘ , ğ‘§}
{ğ‘ , ğ‘§}
{ğ‘ , ğ‘§}
{ğ‘ , ğ‘§}
ğ‘¥= ğ‘‘ğ‘’ğ‘ğ‘¢ğ‘ğ‘›ğ‘¡ğ‘ğ‘¢ğ‘ğ‘›ğ‘¡ğ‘¥, ğ‘ ğ‘¥, ğ‘§ğ‘¥, ğ‘ ğ‘¥, ğ‘§ğ‘¥+ âˆ†ğ‘¥
ğ¹ğ‘ğ‘˜ğ‘’_ğ‘„
Background
24
â–Quantization Types
AI VIETNAM
Seminar
Types
Data 
requirements
Inference 
speed
Performance 
degradation
Dynamic 
Quantization
No data
Slow
Low
Static/Post 
Quantization
Unlabelled 
representative 
sample
Fast
High
Quantization 
aware training
Labelled 
training data
Fast
Low
Background
25
â–Full Fine-tuning
AI VIETNAM
Seminar
Layer Norm
Layer Norm
Feed forward
Multi-Head Self-
Attention
âŠ•
âŠ•
N-layers
ğ‘Šğ¿ğ‘›âˆ’1
ğ‘Šğ¿ğ‘›âˆ’2
ğ‘Šğ¿ğ‘›âˆ’3
ğ‘Šğ¿0
ğ‘Šğ¿1
ğ‘Šğ¿2
â€¦
Adam
Weights
Optimizer
Trained 
Model
Full layers 
fine-tuning
Background
26
â–Fine-tuning a subset of parameters
AI VIETNAM
Seminar
Layer Norm
Layer Norm
Feed forward
Multi-Head Self-
Attention
âŠ•
âŠ•
N-layers
ğ‘Šğ¿ğ‘›âˆ’1
ğ‘Šğ¿ğ‘›âˆ’2
ğ‘Šğ¿ğ‘›âˆ’3
ğ‘Šğ¿0
ğ‘Šğ¿1
ğ‘Šğ¿2
â€¦
Adam
Weights
Optimizer
Trained 
Model
Frozen
Frozen
Frozen some 
layers
Background
27
â–LoRA: Low-rank Adaptation 
AI VIETNAM
Seminar
Reference: https://arxiv.org/abs/2106.09685
ğ‘Š= ğ‘Š0 + âˆ†ğ‘Š
Normal training
â„= ğ‘Šğ‘¥= ğ‘Š0ğ‘¥+ âˆ†ğ‘Šğ‘¥
â„= ğ‘Š0ğ‘¥+ ğµğ´ğ‘¥
LoRA training
ğ‘Š0 âˆˆâ„ğ‘‘Ã—ğ‘˜
âˆ†ğ‘Šâˆˆâ„ğ‘‘Ã—ğ‘˜
ğµâˆˆâ„ğ‘‘Ã—ğ‘Ÿ, ğ´âˆˆâ„ğ‘ŸÃ—ğ‘˜
ğ‘Ÿâ‰ª{ğ‘‘, ğ‘˜}
Trainable 
parameters
ğ‘‘Ã— ğ‘˜
ğ‘ŸÃ— ğ‘‘+ ğ‘˜
*
Background
28
â–Switch to another task
AI VIETNAM
Seminar
Reference: https://arxiv.org/abs/2106.09685
W
*
Task A
Frozen
W
*
Task B
Frozen
Background
29
â–LoRA: Low-rank Adaptatio of LLMs
AI VIETNAM
Seminar
Reference: https://arxiv.org/abs/2106.09685
ğºğ‘ƒğ‘‡3 ğ¶ğ‘œğ‘›ğ‘“ğ‘–ğ‘”= á‰Š
ğ‘™ğ‘ğ‘¦ğ‘’ğ‘Ÿğ‘ = 96
ğ‘‘ğ‘šğ‘œğ‘‘ğ‘’ğ‘™= 12288
ğ‘ğ‘ğ‘Ÿğ‘ğ‘šğ‘ : ~175ğµ
ğ‘‡ğ‘Ÿğ‘ğ‘–ğ‘›ğ‘ğ‘ğ‘™ğ‘’ğ‘ğ‘ğ‘Ÿğ‘ğ‘šğ‘ 
= 2 Ã— ğ‘‘ğ‘šğ‘œğ‘‘ğ‘’ğ‘™Ã— ğ‘ŸÃ— à· ğ¿ğ¿ğ‘œğ‘…ğ´
ğ‘Ÿ= 4
â‡’ğ‘ğ‘ğ‘Ÿğ‘ğ‘šğ‘ 
= 2 Ã— 12288 Ã— 4 Ã— 96 Ã— 4 ~37.7ğ‘€
Background
30
â–Result of LoRA in GPT-2/3
AI VIETNAM
Seminar
Reference: https://arxiv.org/abs/2106.09685
â€œThis suggests that the low-rank adaptation matrix potentially amplifies the 
important features for specific downstream tasks that were learned but not 
emphasized in the general pre-training model.â€
Background
31
â–What is the optimal rank (r) for LoRA
AI VIETNAM
Seminar
Reference: https://arxiv.org/abs/2106.09685
Methods
32
â–Introduction
AI VIETNAM
Seminar
â–QLoRA
â–4-bit Quantization
â–Double Quantization
Methods
33
â–Introduction
AI VIETNAM
Seminar
0
ğ‘¥= 1
ğ‘¥ğ‘=?
-Î±
Î±=4
0
127
-127
QLoRA = Quantization + LoRA 
Methods
34
â–QLoRa
AI VIETNAM
Seminar
Methods
35
â–Block-wise k-bit Quantization
AI VIETNAM
Seminar
Methods
36
â–4-bit NormalFloat Quantization
AI VIETNAM
Seminar
Weights
Normalize
[-1, 1]
Methods
37
â–Double Quantization (DQ) 
AI VIETNAM
Seminar
Evaluation
38
AI VIETNAM
Seminar
Evaluation
39
â–Guanaco with QLoRA 
AI VIETNAM
Seminar
Conclusion
40
AI VIETNAM
Seminar
Conclusion
41
AI VIETNAM
Seminar
â€¢
4-bit finetuning with LoRA replicate 
16-bit full finetuning.
â€¢
QLoRA + Guanaco â€“ archive State-
of-the-art performance AI chatbot.
Advantages
Limitations
â€¢
Can not evaluation with difference bit 
(such as 3-bit).
â€¢
Cannot marger with difference 
adapter
42
