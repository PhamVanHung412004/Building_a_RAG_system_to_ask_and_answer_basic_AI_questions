Style Transfer
Beyond the content and style losses
Year 2024
Quang-Vinh Dinh
Ph.D. in Computer Science
AI VIETNAM
All-in-One Course
Objectives
âœ“Study about content loss + style loss
âœ“Implementation of a simple method
Pretrained 
Model
Content 
Loss
Style Image
Pretrained 
Model
Feature map
Pretrained 
Model
Content Image
Output 
Image
Style 
Loss
Total 
Loss
â¢Quick Review
â¢Content Loss+Style Loss
â¢Implementation
â¢Einstein Summation
â¢Extensions
Outline
Review
â– Pretrained model (VGG19)
AI VIETNAM
All-in-One Course
(3x3) Convolution
padding=â€˜sameâ€™
stride=1 + ReLU
(2x2) max pooling
Dense Layer
+ ReLU
(4096) 
Dense Layer
+ Softmax
(1000) 
Block-1
Block-2
Block-3
Block-4
Block-5
Dense Block
input
(224,224,3)
(64,112,112)
(256,56,56)
(512,7,7)
(512,28,28)
(512,14,14)
output
Low abstract feature
High abstract feature
Local and Global
Spatial Information Constraint
?
?
Detection Problem
Copying Problem
1
Review
â– Content Loss
AI VIETNAM
All-in-One Course
Target 
Image
Noise 
Image
Pretrained 
Model
Pretrained 
Model
Feature 
map
Feature 
map
Variable
Constant
Content Loss
2
Review
AI VIETNAM
All-in-One Course
ğºğ‘–ğ‘—= à·
ğ‘˜
ğ‘‰ğ‘–ğ‘˜ğ‘‰ğ‘—ğ‘˜
.
=
Gram matrix
ğ‘‰ğ‘‡
ğ‘‰
.
=
26 17 19
17 14 18
19 18 50
Gram matrix
ğ‘‰ğ‘‡
ğ‘‰
4
0
3
3
0
1
4
5
0
1
2
3
4
0
3
3
0
1
4
5
0
1
2
3
â– Gram Matrix
3
Review
AI VIETNAM
All-in-One Course
.
=
Gram matrix
ğ‘‰ğ‘‡
ğ‘‰
.
=
26 17 19
17 14 18
19 18 50
Gram matrix
ğ‘‰ğ‘‡
ğ‘‰
4
0
3
3
0
1
4
5
0
1
2
3
4
0
3
3
0
1
4
5
0
1
2
3
ğºğ‘–ğ‘—= à·
ğ‘˜
ğ‘‰ğ‘–ğ‘˜ğ‘‰ğ‘—ğ‘˜
â– Gram Matrix
4
Gram 
Matrix
ğºğ‘–ğ‘—= à·
ğ‘˜
ğ‘‰ğ‘–ğ‘˜ğ‘‰ğ‘—ğ‘˜
.
=
26 17 19
17 14 18
19 18 50
Gram matrix
ğ‘‰ğ‘‡
ğ‘‰
4
0
3
3
0
1
4
5
0
1
2
3
4
0
3
3
0
1
4
5
0
1
2
3
4
0
3
1
4
0
3
1
.
= 26
4
0
3
1
4
0
3
1
.
= 26
x. y = à·
1
ğ‘›
ğ‘¥ğ‘–ğ‘¦ğ‘–
Algebra
x. y =
x
y ğ‘ğ‘œğ‘ ğ›¼
Geometry
x
ğ›¼
x ğ‘ğ‘œğ‘ ğ›¼
y
Inner Product
Position-invariant measure
Review
â– Gram matrix
https://pytorchtaipei.github.io/articles/PyTorchTP-Style-Transfer/
6
Review
â– Style Loss
AI VIETNAM
All-in-One Course
Target 
Image
Noise 
Image
Pretrained 
Model
Pretrained 
Model
Feature 
map ğ¹1
Feature 
map ğ¹2
Style Loss
ğºğ¹1 âˆ’ğºğ¹2
2
7
â¢Quick Review
â¢Content Loss+Style Loss
â¢Implementation
â¢Einstein Summation
â¢Extensions
Outline
Style Transfer
â– Content Loss + Style Loss
AI VIETNAM
All-in-One Course
Pretrained 
Model
Content 
Loss
Style Image
Pretrained 
Model
Feature map
Pretrained 
Model
Content Image
Output 
Image
Style 
Loss
Total 
Loss
8
Style Transfer
â– Using the content image as initialization for the output image
AI VIETNAM
All-in-One Course
Pretrained 
Model
Content 
Loss
Style Image
Pretrained 
Model
Feature map
Pretrained 
Model
Content Image
Output 
Image
Style 
Loss
Total 
Loss
9
https://arxiv.org/pdf/1508.06576v2.pdf
10
Shape=(3, 32, 32)
Shape=(3, 32, 32)
Shape=(3, 32, 32)
212
215
214
217
â€¦
â€¦
128
120
123
116
â€¦
â€¦
â€¦
â€¦
â€¦
223
214
232
195
â€¦
â€¦
66
79
102
94
Content image
Output image
Style image
204
207
206
209
â€¦
â€¦
131
123
126
119
â€¦
â€¦
â€¦
â€¦
â€¦
182
173
189
152
â€¦
â€¦
45
55
82
72
168
171
170
172
â€¦
â€¦
112
104
107
100
â€¦
â€¦
â€¦
â€¦
â€¦
150
141
155
118
â€¦
â€¦
44
55
83
74
212
215
214
217
â€¦
â€¦
128
120
123
116
â€¦
â€¦
â€¦
â€¦
â€¦
223
214
232
195
â€¦
â€¦
66
79
102
94
204
207
206
209
â€¦
â€¦
131
123
126
119
â€¦
â€¦
â€¦
â€¦
â€¦
182
173
189
152
â€¦
â€¦
45
55
82
72
168
171
170
172
â€¦
â€¦
112
104
107
100
â€¦
â€¦
â€¦
â€¦
â€¦
150
141
155
118
â€¦
â€¦
44
55
83
74
251
253
253
254
â€¦
â€¦
197
193
197
192
â€¦
â€¦
â€¦
â€¦
â€¦
252
254
253
253
â€¦
â€¦
183
181
184
182
72
75
72
75
â€¦
â€¦
102
106
104
107
â€¦
â€¦
â€¦
â€¦
â€¦
43
45
44
44
â€¦
â€¦
24
28
22
26
123
124
121
123
â€¦
â€¦
111
113
111
113
â€¦
â€¦
â€¦
â€¦
â€¦
85
87
86
86
â€¦
â€¦
65
66
64
65
â– Example
AI VIETNAM
All-in-One Course
11
Shape=(3, 32, 32)
Shape=(3, 32, 32)
Shape=(3, 32, 32)
Content image
Output image
Style image
ContentLoss
(MSE)
VGG19
VGG19
Conv_1
Conv_1
0.00
0.00
â€¦
0.00
0.00
0.1404
1.1997
â€¦
0.00
0.00
0.1497
1.2336
â€¦
0.00
0.00
â€¦
â€¦
â€¦â€¦
â€¦
0.00
0.00
â€¦
0.3542
0.00
0.00
0.00
â€¦
0.363
0.00
0.00
0.3599
â€¦
0.3546
0.00
0.00
0.00
â€¦
0.00
0.00
0.00
1.1288
â€¦
0.00
0.00
0.00
1.403
â€¦
0.00
0.00
â€¦
â€¦
â€¦â€¦
â€¦
0.00
0.00
â€¦
1.2826
0.00
0.00
0.00
â€¦
1.2425
0.00
0.00
0.4229
â€¦
1.0897
0.00
4.18ğ‘’âˆ’5
4.39ğ‘’âˆ’4
4.39ğ‘’âˆ’4
3.72ğ‘’âˆ’2
â€¦
â€¦
4.7ğ‘’âˆ’5
0.00
1.35ğ‘’âˆ’2
0.00
â€¦
â€¦
â€¦
â€¦
â€¦
4.7ğ‘’âˆ’5
1.35ğ‘’âˆ’2
0.00
0.00
â€¦
â€¦
1.04ğ‘’âˆ’2
0.00
0.00
0.00
0.00
0.00
0.00
2.75ğ‘’âˆ’2
â€¦
â€¦
0.00
0.00
1.38ğ‘’âˆ’2
0.00
â€¦
â€¦
â€¦
â€¦
â€¦
0.00
1.38ğ‘’âˆ’2
0.00
0.00
â€¦
â€¦
1.93ğ‘’âˆ’2
0.00
0.00
0.00
StyleLoss
(MSE)
Gram matrix
12
ContentLoss
(MSE)
StyleLoss
(MSE)
ContentWeight
(1)
StyleWeight
(1e6)
TotalLoss (L)
0.0231
âˆ’0.0083
0.0434
0.0678
â€¦
â€¦
âˆ’0.037
âˆ’0.1309
0.0996
âˆ’0.0534
â€¦
â€¦
â€¦
â€¦
â€¦
âˆ’0.017
âˆ’0.0192
0.0175
0.0347
â€¦
â€¦
0.0358
âˆ’0.0135
0.1084
0.0578
0.0407
0.0107
0.0652
0.01011
â€¦
â€¦
âˆ’0.0027
âˆ’0.1198
0.1118
âˆ’0.0578
â€¦
â€¦
â€¦
â€¦
â€¦
0.022
0.0262
0.0164
0.0203
â€¦
â€¦
0.0299
âˆ’0.0281
0.0662
0.0242
0.0245
0.0201
0.0283
0.0521
â€¦
â€¦
0.0312
âˆ’0.0136
0.04
âˆ’0.003
â€¦
â€¦
â€¦
â€¦
â€¦
0.0382
0.0378
âˆ’0.0006
âˆ’0.009
â€¦
â€¦
0.0021
âˆ’0.0126
âˆ’0.021
âˆ’0.0168
Shape=(3, 32, 32)
Output image
212
215
214
217
â€¦
â€¦
128
120
123
116
â€¦
â€¦
â€¦
â€¦
â€¦
223
214
232
195
â€¦
â€¦
66
79
102
94
204
207
206
209
â€¦
â€¦
131
123
126
119
â€¦
â€¦
â€¦
â€¦
â€¦
182
173
189
152
â€¦
â€¦
45
55
82
72
168
171
170
172
â€¦
â€¦
112
104
107
100
â€¦
â€¦
â€¦
â€¦
â€¦
150
141
155
118
â€¦
â€¦
44
55
83
74
199
227
201
204
â€¦
â€¦
140
132
110
128
â€¦
â€¦
â€¦
â€¦
â€¦
235
226
219
182
â€¦
â€¦
53
91
89
81
191
194
193
196
â€¦
â€¦
143
135
113
131
â€¦
â€¦
â€¦
â€¦
â€¦
169
160
176
139
â€¦
â€¦
32
67
69
59
155
158
157
159
â€¦
â€¦
99
116
94
112
â€¦
â€¦
â€¦
â€¦
â€¦
137
128
167
130
â€¦
â€¦
31
67
95
86
ğ‘‡ğ‘ğ‘Ÿğ‘”ğ‘’ğ‘¡= Target âˆ’ğ‘™ğ‘ŸÃ— ğ‘‘ğ¿
Update Parameters
(ğ‘™ğ‘Ÿ= 0.05)
âˆ’0.05 Ã—
âˆ’0.05 Ã—
âˆ’0.05 Ã—
Note: the pixel value of the ouput image 
when training will be normalized, not in 
uint8 type. 
13
â¢Quick Review
â¢Content Loss+Style Loss
â¢Implementation
â¢Einstein Summation
â¢Extensions
Outline
Style Transfer
â– Content Loss + Style Loss
14
AI VIETNAM
All-in-One Course
Content 
Loss
Style Image
Pretrained 
Model
Feature map
Pretrained 
Model
Content Image
Output 
Image
Style 
Loss
Total 
Loss
Style Transfer
(1) Data Preparation
AI VIETNAM
All-in-One Course
Style Image
Content Image
Output 
Image
Style Transfer
(2) Content Loss
16
AI VIETNAM
All-in-One Course
Content 
Loss
Content Image
Output 
Image
Style Transfer
â– Content Loss + Style Loss
17
Style Image
Pretrained 
Model
Feature map ğ¹2
Pretrained 
Model
Output Image
Feature map ğ¹1
Style Transfer
â– Content Loss + Style Loss
Pretrained 
Model
Pretrained 
Model
Style Loss
ğºğ¹1
ğºğ¹2
Feature map ğ¹2
Feature map ğ¹1
Style Transfer
â– Content Loss + Style Loss
Content 
Loss
Style Image
Feature map
Output 
Image
Style Loss
Total 
Loss
â€¦
â€¦
Style Transfer
â– Content Loss + Style Loss
20
AI VIETNAM
All-in-One Course
â¢Quick Review
â¢Content Loss+Style Loss
â¢Implementation
â¢Einstein Summation
â¢Extensions
Outline
Gram Matrix
4
AI VIETNAM
All-in-One Course
21
ğºğ‘–ğ‘—= à·
ğ‘˜
ğ‘‰ğ‘–ğ‘˜ğ‘‰ğ‘—ğ‘˜
.
=
Gram matrix
ğ‘‰ğ‘‡
ğ‘‰
.
=
26 17 19
17 14 18
19 18 50
Gram matrix
ğ‘‰ğ‘‡
ğ‘‰
4
0
3
3
0
1
4
5
0
1
2
3
4
0
3
3
0
1
4
5
0
1
2
3
Einstein Summation
4
AI VIETNAM
All-in-One Course
22
Dot product
0
3
=
11
ğ‘¢
ğ‘£
ğ‘Ÿ
3
2
4
1
2
1
ğ‘–, ğ‘– â†’ 
0
3
ğ‘¢
ğ‘£
2
1
ğ‘–â†’
ğ‘Ÿ= à·
ğ‘–
ğ‘¢ğ‘–ğ‘£ğ‘–= ğ‘¢1ğ‘£1 + ğ‘¢2ğ‘£2 + â‹¯
4
1
3
2
ğ‘–â†’
Einstein Summation
4
AI VIETNAM
All-in-One Course
23
0
3
=
ğ‘¢
ğ‘£
ğ‘Ÿ
2
1
ğ‘–, ğ‘— â†’ ğ‘–
0
3
ğ‘¢
ğ‘£
2
1
ğ‘—â†’
ğ‘Ÿğ‘–= à·
ğ‘—
ğ‘¢ğ‘–ğ‘£ğ‘—= ğ‘¢ğ‘–ğ‘£1 + ğ‘¢ğ‘–ğ‘£2 + â‹¯
4
1
3
2
ğ‘–â†’
4
1
3
2
24
6
18
12
Einstein Summation
4
AI VIETNAM
All-in-One Course
24
ğ‘–, ğ‘— â†’ğ‘—
0
3
ğ‘¢
ğ‘£
2
1
ğ‘—â†’
ğ‘Ÿğ‘—= à·
ğ‘–
ğ‘¢ğ‘–ğ‘£ğ‘—= ğ‘¢1ğ‘£ğ‘—+ ğ‘¢1ğ‘£ğ‘—+ â‹¯
4
1
3
2
ğ‘–â†’
0
3
=
ğ‘¢
ğ‘£
ğ‘Ÿ
2
1
4
1
3
2
0
30
20
10
Einstein Summation
4
AI VIETNAM
All-in-One Course
25
Outer product
ğ‘–, ğ‘— â†’ ğ‘–ğ‘—
0
3
ğ‘¢
ğ‘£
2
1
ğ‘—â†’
ğ‘Ÿğ‘–ğ‘—= ğ‘¢ğ‘–ğ‘£ğ‘—
4
1
3
2
ğ‘–â†’
=
ğ‘¢
ğ‘£
ğ‘Ÿ
2
1
0
3
4
1
3
2
8
2
6
4
4
1
3
2
0
0
0
0
12
3
9
6
Einstein Summation
4
AI VIETNAM
All-in-One Course
26
Transpose
ğ´
0
2
1
3
1
4
ğ´ğ‘‡
transpose
0
2
3
1
4
1
ğ‘–ğ‘— â†’ ğ‘—ğ‘–
ğ´
0
2
1
3
1
4
2
0
3
5
1
4
ğ´ğ‘‡
ğ‘–â†’
â†’
ğ‘—
ğ‘—â†’
â†’
ğ‘˜
ğ´ğ‘‡ğ‘—ğ‘–= ğ´ğ‘–ğ‘—
Einstein Summation
4
AI VIETNAM
All-in-One Course
27
Diagonal
ğ´
ğ‘Ÿ
3
5
1
2
5
3
4
2
1
3
1
6
diagonal
ğ‘–ğ‘– â†’ ğ‘–
2
5
3
4
2
1
3
1
6
ğ‘–â†’
â†’
ğ‘–
3
5
1
ğ‘–â†’
ğ‘Ÿğ‘–= ğ´ğ‘–ğ‘–
Einstein Summation
4
AI VIETNAM
All-in-One Course
28
Trace
ğ´
ğ‘Ÿ
9
2
5
3
4
2
1
3
1
6
trace
ğ‘–ğ‘– â†’ 
2
5
3
4
2
1
3
1
6
ğ‘–â†’
â†’
ğ‘–
ğ‘Ÿ= à·
ğ‘–
ğ´ğ‘–ğ‘–
Einstein Summation
4
AI VIETNAM
All-in-One Course
29
ğ‘–ğ‘—, ğ‘–ğ‘— â†’ ğ‘–ğ‘—
ğ´
3
0
1
2
2
3
ğµ
ğ¶
ğ‘–â†’
â†’
ğ‘—
ğ¶ğ‘–ğ‘—= ğ´ğ‘–ğ‘—ğµğ‘–ğ‘—
Element-wise multiplication
=
ğ´
3
0
1
2
2
3
ğµ
ğ¶
1
0
2
3
2
1
â¨€
3
0
2
6
4
3
1
0
2
3
2
1
ğ‘–â†’
â†’
ğ‘—
3
0
2
6
4
3
ğ‘–â†’
â†’
ğ‘—
Einstein Summation
4
AI VIETNAM
All-in-One Course
30
.
=
3
6
18 32
ğ´
0
2
1
3
1
4
2
0
3
5
1
4
ğµ
ğ¶
ğ‘–ğ‘—, ğ‘—ğ‘˜ â†’ ğ‘–ğ‘˜
3
6
18 32
ğ´
0
2
1
3
1
4
2
0
3
5
1
4
ğµ
ğ¶
ğ‘–â†’
â†’
ğ‘—
ğ‘—â†’
â†’
ğ‘˜
ğ‘–â†’
â†’
ğ‘˜
ğ¶ğ‘–ğ‘˜= à·
ğ‘—
ğ´ğ‘–ğ‘—ğµğ‘—ğ‘˜= ğ´ğ‘–1ğµ1ğ‘˜+ ğ´ğ‘–2ğµ2ğ‘˜+ â‹¯
Matrix multiplication
Einstein Summation
AI VIETNAM
All-in-One Course
.
=
3
6
18 32
ğ´
0
2
1
3
1
4
2
0
3
5
1
4
ğµ
ğ¶
ğ‘–ğ‘—, ğ‘—ğ‘˜ â†’
3
6
18 32
ğ´
0
2
1
3
1
4
2
0
3
5
1
4
ğµ
ğ¶
ğ‘–â†’
â†’
ğ‘—
ğ‘—â†’
â†’
ğ‘˜
ğ‘–â†’
â†’
ğ‘˜
ğ¶ğ‘–ğ‘˜= à·
ğ‘—
ğ´ğ‘–ğ‘—ğµğ‘—ğ‘˜= ğ´ğ‘–1ğµ1ğ‘˜+ ğ´ğ‘–2ğµ2ğ‘˜+ â‹¯
Matrix multiplication
Repeated indices are summed if the output indices are not specified.
â¢Quick Review
â¢Content Loss+Style Loss
â¢Implementation
â¢Einstein Summation
â¢Extensions
Outline
Multi-modal 
Style Transfer
Multi-modal Style Transfer
AI VIETNAM
All-in-One Course
32
33
Multi-modal 
Style Transfer
â– Shuffle feature maps
34
Output 
Image 1
Output 
Image 2
Multi-modal Style Transfer
â– Deep feature rotation
AI VIETNAM
All-in-One Course
35
Multi-modal 
Style Transfer
â– Deep feature rotation
Multi-modal 
Style Transfer
â– Results
â– Two style images
7.2.Style_transfer_1content_2style.ipynb
Multi-modal Style Transfer
â– Two style images
39
AI VIETNAM
All-in-One Course
7.3.Style_transfer_1content_2style.ipynb
Epoch 1
Epoch 3
Epoch 10
Multi-modal Style Transfer
â– Two style images
40
AI VIETNAM
All-in-One Course
7.4.Style_transfer_1content_2style.ipynb
Epoch 1
Epoch 3
Epoch 10
Multi-modal Style Transfer
â– Using the Euclidian Distance
41
AI VIETNAM
All-in-One Course
Epoch 1
Epoch 3
Epoch 10
Multi-modal 
Style Transfer
â– Different measures
Multi-modal Style Transfer
â– Results
AI VIETNAM
All-in-One Course
43
Multi-modal 
Style Transfer
â– Results
â¢Quick Review
â¢Content Loss+Style Loss
â¢Implementation
â¢Einstein Summation
â¢Extensions
Summary
Summary
âœ“Studied about content loss + style loss
âœ“Implemented simple methods
âœ“Studied the Einsum and applied to style transfer
âœ“Discussed ideas beyond the traditional style transfer
